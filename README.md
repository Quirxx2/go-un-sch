# Golang United School Certificates
[Design Document](https://docs.google.com/document/d/1UoHbZ6ue_-ziny2xmDFsllWlvOQzvNU06i6KK6RvODo)
## How to launch e2e demo test:

[Storage](#storage) for demo test will be pointing to `./tmp/e2e/demo`, where you can find generated certificates.

- Keep service up after test execution:
    
    `$ make test.e2e t=e2edemo_test.go`

    You can access service through `gRPC` or `REST` [API](#api) or launch `make` target to stop service:

    `$ make down`

- Or just run test and stop service with single `make` target:

    `$ make test.e2e.all`

## Overview

Service consists of 4 parts:
### API
`API` is **gRPC-first**, [api/certs.proto](api/certs.proto).

**REST** api implemented using [reverse proxy](https://github.com/grpc-ecosystem/grpc-gateway), [api/certs.yaml](api/certs.yaml).

`API` generates PDF files only on demand, invoking `AddCertificate` method creates certificate data entry in [Registry](#registry). First `GetCertificate` call will generate PDF file for it.

For preemptive generation see [Questions](#3-preemptive-generation).

Template related methods:
- `AddTemplate` | `POST /template`  - adds new template to [Registry](#registry).
- `GetTemplate` | `GET /template/{name}` - returns template by name.
- `ListTemplates` | `GET /templates` - return names of available templates.
- `UpdateTemplate` | `PATCH /template/{name}` - updates template name or content.
- `DeleteTemplate` | `DELETE /template/{name}` - delete template from [Registry](#registry).
- `TestTemplate` | `POST /template/{name}/test` - renders template into PDF file using provided test data and returns it.

Certificate related methods:
- `AddCertificate` | `POST /certificate` - adds new certificate to [Registry](#registry) and returns generated `id`.
- `GetCertificate` | `GET /certificate/{id}` - generates PDF file for certificate if needed and returns it.
- `GetCertificateLink` | `GET /certificate/{id}/link` - returns link to certificate, e.g. `http://localhost:8080/certificate/1d28bdcd`.
- `UpdateCertificate` | `PATCH /certificate/{id}` - updates certificate.
- `DeleteCertificate` | `DELETE /certificate/{id}` - deletes certificate from [Registry](#registry) and generated file from [Storage](#storage).
### Templater
Templater generates **HTML templates** into **PDF files** with [gotenberg](https://github.com/gotenberg/gotenberg).

Template should be a **single** HTML file, with all resources embedded into it as **base64** strings.

Example of such template and process of its generation you can find in [examples/template](examples/template).

### Registry
Registry used for storing **persistent** data: **HTML templates** and **certificates data**.

PostgreSQL used as a backend.

HTML templates represented by named HTML strings.

Certificate data contains of "**preformatted strings**" (see [Question](#1-certificate-data) on certificate data), such as:
- `student` - student name, e.g. "Ivan Ivanov"
- `issue_date` - certificate issue date, e.g. "1 December 1999"
- `course` - course title, e.g. "Test Course Title"
- `mentors` - single string contains all mentors, e.g. "Mentor One, Mentor Two".

Also certificate keeps reference to template.

And contains few autogenerated fields:
- `id` - unique `id` for certificate in format of **8 character hex string**, e.g. "1d28bdcd"
- `timestamp` - time stamp for validating generated certificate files saved in [Storage](#storage).

### Storage
`Storage` storing **temporary** data - generated PDF certificates, they always can be recreated from persistent data stored in [Registry](#registry).

`Storage` acts as **LRU cache** deleting least recently used PDF files.

It implemented using [vfs](https://github.com/C2FO/vfs).

Local storage backend is tested, AWS S3 backend is in [TODO](#todo).

Potentially it can use Google Cloud Storage, Microsoft Azure Blob Storage and SFTP also as backends.

## Questions for mentors
### 1. Certificate data.
We using simplified approach when client provides "preformatted" strings as data for certificate. It let us avoid errorprone operations inside html template, e.g. formatting date. It let client easily test formatting for those fields on their end. And client can pass any string, which can let client keep html template unmodified when formatting for those fields need to be different for some cases.

**Q: Should we stick to that approach, or certificate fields should be more complex, e.g.: `issue_date` as date or `mentors` as list of strings?**

### 2. Complex relations.
Our service keep single relation: `certificate` -> `template`, and we assuming that all complex relations like `student` -> `certificates` (as proposed by @DzmitryYafremenka) and etc. are handled by client, because such relations lead to unnecessary complexity.
For `student` -> `certificates` we would need to distinct students with same names, so we can't use simple `SELECT` by name. Client would need to provide additional data for `student` or service would need to have process of creation new unique students, etc.

**Q: Should we introduce any additional relations?**

### 3. Preemptive Generation.
We generate certificate PDF file only when it directly requested by `GetCertificate` method.

`AddCertificate` method adds new certificate entry to [Registry](#registry), and do not handle any generation, injecting preemptive generation into it leads to handling two responsibilities creating new certificate and generating it. If generation failed do we need to rollback certificate creation? If not, then we will just suppress certificate creation, and behavior of `AddCertificate` becomes undefined for client. 

But we can introduce unambiguous method `GenerateCertificate` which will handle certificate generation and client can use it directly implementing own preemptive generation strategy if it needed.

**Q: Do we need preemptive generation? If yes, just dedicated method for it, `GenerateCertificate`?**

### 4. License 

**Q: Under which license we writing code?**

## TODO

- [ ] GitLab CI/CD.
- [ ] `Storage` need evictionCallback with proper file deletion in another goroutine with retries and etc.
- [ ] State for `Registry`.
- [ ] State for `Storage`.
- [ ] Proper `Size()` for all `Cacheable` values.
- [ ] Custom HTTP Response status codes, e.g. `AddCertificate` should return `201` instead of default `200`.
- [ ] Authentication.
- [ ] Graceful shutdown.
- [ ] Service Configuration.
- [ ] Proper main.go.
- [ ] Proper docs.
- [ ] Generating OpenApi description.
- [ ] Swagger UI.
- [ ] Integration test for AWS S3 using [LocalStack](https://github.com/localstack/localstack).
- [ ] Logging.
- [ ] Monitoring.
